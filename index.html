<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Uzzi Info</title>

<!-- Fonts & minor reset -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  /* -------------------------
     Uzzi Info — Single-file SPA
     Dark professional X-like theme
     ------------------------- */
  :root{
    --bg:#0b0d0f;
    --panel:#0f1720;
    --muted:#9aa4b2;
    --accent:#1da1f2; /* subtle X-blue */
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#05060a 0%,var(--bg) 100%);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#e8eef6;-webkit-font-smoothing:antialiased}
  a{color:var(--accent);text-decoration:none}
  .app{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,#081021,#0b1622);display:grid;place-items:center;font-weight:800;font-size:22px;color:#fff}
  .title{line-height:1}
  .title h1{margin:0;font-size:18px;font-weight:800}
  .title .sub{font-size:12px;color:var(--muted)}
  nav{display:flex;gap:8px}
  .nav-btn{background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .nav-btn.active{color:#fff;background:var(--glass)}
  .card{background:var(--panel);padding:18px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  .center{display:grid;place-items:center}
  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px}
  .col{flex:1}
  input, textarea, select {
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:14px;
  }
  textarea{min-height:110px;resize:vertical}
  .btn{background:var(--accent);color:#071026;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
  .profile-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px}
  .avatar{width:72px;height:72px;border-radius:999px;background:rgba(255,255,255,0.04);display:grid;place-items:center;font-weight:800;font-size:20px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
  .grid{display:grid;gap:14px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  .search-row{display:flex;gap:10px;align-items:center}
  .footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
  .notice{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(29,161,242,0.06), rgba(29,161,242,0.02));border:1px solid rgba(29,161,242,0.06);color:var(--muted)}
  /* responsive */
  @media (max-width:820px){
    .row{flex-direction:column}
    .grid.cols-3{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="app">

    <!-- Header / Branding -->
    <header>
      <div class="brand">
        <div class="logo">UZ</div>
        <div class="title">
          <h1>Uzzi Info</h1>
          <div class="sub">Profiles · Skills · Trending</div>
        </div>
      </div>

      <!-- Nav: hidden until logged in -->
      <nav id="nav" style="visibility:hidden">
        <button class="nav-btn" data-view="home">Home</button>
        <button class="nav-btn" data-view="search">Search</button>
        <button class="nav-btn" data-view="me">Me</button>
        <button class="nav-btn" data-view="about">About</button>
        <button id="btnSignOut" class="nav-btn">Sign out</button>
      </nav>
    </header>

    <!-- MAIN card area where sections swap -->
    <main id="mainArea">

      <!-- AUTH SECTION (visible initially) -->
      <section id="authSection" class="card center" style="padding:28px;gap:12px">
        <div style="max-width:520px;width:100%">
          <h2 style="margin:0 0 6px 0">Welcome to Uzzi Info</h2>
          <div class="small muted" style="margin-bottom:12px">Sign up or log in to create your profile, control privacy, and discover trending people.</div>

          <div id="authMsg" class="small muted" style="margin-bottom:12px"></div>

          <div class="grid">
            <input id="authEmail" placeholder="Email (you control this)" />
            <input id="authPassword" type="password" placeholder="Password (8+ chars)" />
            <div style="display:flex;gap:8px">
              <button id="btnSignUp" class="btn col">Create account</button>
              <button id="btnLogin" class="btn ghost col">Login</button>
            </div>
            <div class="small muted">We recommend email verification. We store minimal data — do not add other people's private info.</div>
          </div>
        </div>
      </section>

      <!-- APP SECTIONS (hidden until sign-in) -->

      <!-- HOME / Trending -->
      <section id="home" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <h2 style="margin:0">Trending Profiles</h2>
              <div class="small muted">Most viewed & recently active profiles</div>
            </div>
            <div style="min-width:220px">
              <input id="quickSearch" placeholder="Search by name or skill" />
            </div>
          </div>

          <div id="trending" style="margin-top:16px" class="grid"></div>
        </div>
      </section>

      <!-- SEARCH -->
      <section id="search" style="display:none">
        <div class="card">
          <h2 style="margin-top:0">Search Profiles</h2>
          <div class="search-row" style="margin-top:8px">
            <input id="searchQ" placeholder="Name, username or skill" />
            <button id="doSearch" class="btn">Search</button>
          </div>
          <div id="searchResults" style="margin-top:14px" class="grid"></div>
        </div>
      </section>

      <!-- ME: edit profile + view your public profile -->
      <section id="me" style="display:none">
        <div class="card">
          <h2 style="margin:0 0 6px 0">Your Profile</h2>
          <div class="small muted">Fill in your details. Toggle visibility at bottom.</div>

          <div style="margin-top:12px" class="grid">
            <div class="row">
              <div style="width:94px" class="center">
                <div id="avatarPreview" class="avatar">UZ</div>
              </div>
              <div class="col">
                <input id="p_username" placeholder="Username (unique)" />
                <input id="p_full_name" placeholder="Full name" />
                <input id="p_father" placeholder="Father's name (sensitive)" />
              </div>
            </div>

            <input id="p_avatar" placeholder="Avatar URL (optional)" />
            <textarea id="p_bio" placeholder="Short bio (what you do)"></textarea>

            <div class="row">
              <input id="p_skills" placeholder="Skills (comma separated)" />
              <input id="p_interests" placeholder="Interests (comma separated)" />
            </div>

            <div class="row">
              <input id="p_whatsapp" placeholder="WhatsApp username/number (sensitive)" />
              <input id="p_instagram" placeholder="Instagram handle / URL" />
            </div>
            <div class="row">
              <input id="p_tiktok" placeholder="TikTok handle / URL" />
              <input id="p_facebook" placeholder="Facebook / URL" />
            </div>

            <div style="display:flex;align-items:center;gap:12px">
              <label style="display:flex;align-items:center;gap:8px">
                <input id="p_public" type="checkbox" /> <span class="small muted">Make profile public (visible to everyone)</span>
              </label>
              <div style="margin-left:auto"><button id="saveProfile" class="btn">Save profile</button></div>
            </div>

            <div id="meMsg" class="small muted"></div>
          </div>
        </div>

        <div style="height:16px"></div>

        <!-- quick preview of public view -->
        <div class="card" id="previewBox" style="display:none">
          <h3 style="margin:0">Public preview</h3>
          <div id="publicPreview" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- ABOUT -->
      <section id="about" style="display:none">
        <div class="card">
          <h2 style="margin-top:0">About Uzzi Info</h2>
          <p class="small muted">Uzzi Info is a professional, privacy-aware profiles hub. Users create accounts, showcase skills and social links, and control visibility per profile. Built by <strong>Uzair Ahmad</strong>.</p>
          <div style="height:12px"></div>
          <div class="notice small">Rules: Do not publish private information of others. Keep phone/ID information private unless you own it.</div>
          <div style="height:12px"></div>
          <div class="small muted">Hosted on GitHub Pages · Backend: Supabase</div>
        </div>
      </section>

    </main>

    <footer class="footer">© Uzzi Info — Built & maintained by Uzair Ahmad</footer>
  </div>

<!-- -------------------------
     Supabase & App Logic
     ------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
/* ========== CONFIG: your Supabase credentials ========== */
/* Supabase Project URL & anon key (public) - provided earlier by you */
const SUPABASE_URL = "https://mppmeggeagbbvsnxmrtd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wcG1lZ2dlYWdiYnZzbnhtcnRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMzU3MzMsImV4cCI6MjA3NDkxMTczM30.i-6ie8z4nBTCarmlwP1oI0o76ofxW8iUOn5aGh4Gsl0";
/* ===================================================== */

const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, detectSessionInUrl: true } });

/* ----- tiny DOM helpers ----- */
const q = sel => document.querySelector(sel);
const qAll = sel => document.querySelectorAll(sel);
const nav = q('#nav');
const authSection = q('#authSection');
const mainArea = q('#mainArea');
const authMsg = q('#authMsg');
const navButtons = Array.from(qAll('.nav-btn'));
const sections = { home: q('#home'), search: q('#search'), me: q('#me'), about: q('#about') };

/* ----- routing / view switching ----- */
function showView(view){
  // hide auth when logged in
  if(view !== 'auth'){ authSection.style.display = 'none'; nav.style.visibility = 'visible' }
  // show/hide sections
  Object.keys(sections).forEach(k => sections[k].style.display = (k === view ? 'block' : 'none'));
  // active nav state
  navButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
}

/* ----- auth UI ----- */
q('#btnSignUp').onclick = async () => {
  const email = q('#authEmail').value.trim();
  const password = q('#authPassword').value;
  if(!email || password.length < 8){ authMsg.textContent = 'Use a valid email and password (8+ chars).'; return; }
  authMsg.textContent = 'Creating account...';
  const { data, error } = await supabase.auth.signUp({ email, password });
  if(error){ authMsg.textContent = 'Error: ' + error.message; console.error(error); return; }
  authMsg.textContent = 'Account created. Check your email to verify. After verification, log in.';
};

q('#btnLogin').onclick = async () => {
  const email = q('#authEmail').value.trim();
  const password = q('#authPassword').value;
  if(!email || password.length < 1){ authMsg.textContent = 'Enter email and password.'; return; }
  authMsg.textContent = 'Signing in...';
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ authMsg.textContent = 'Error: ' + (error.message || 'Login failed'); console.error(error); return; }
  authMsg.textContent = 'Signed in.';
  await initAfterSignIn();
};

/* sign-out */
q('#btnSignOut').onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

/* handle auth state changes (persist session) */
supabase.auth.onAuthStateChange(async (event, session) => {
  if(event === 'SIGNED_IN'){
    await initAfterSignIn();
  }
  if(event === 'SIGNED_OUT'){
    // show auth form again
    authSection.style.display = 'block';
    nav.style.visibility = 'hidden';
    Object.keys(sections).forEach(k => sections[k].style.display = 'none');
  }
});

/* ----- after sign-in init ----- */
async function initAfterSignIn(){
  // hide auth and show home by default
  authSection.style.display = 'none';
  nav.style.visibility = 'visible';
  showView('home');

  // wire nav buttons
  navButtons.forEach(b => b.onclick = ()=> showView(b.dataset.view) );

  // load data
  await loadTrending();
  wireQuickSearch();
  await loadMyProfile();
}

/* ----- utilities for DB schema differences ----- */
function safeGetProfileIdentifierField() {
  // some DBs use id = auth.users.id, others use user_id; we try both
  // we'll prefer 'id' (if profiles.id references auth.users.id), else 'user_id'
  return ['id','user_id'];
}

/* ----- TRENDING (Home) ----- */
async function loadTrending(){
  const wrap = q('#trending'); wrap.innerHTML = '<div class="small muted">Loading...</div>';
  try{
    // fetch public profiles. Accept different schema possibilities: profile_public boolean OR visibility->public boolean
    // We will request a broad select and filter client-side if necessary.
    const { data, error } = await supabase
      .from('profiles')
      .select('id, user_id, username, full_name, skills, avatar_url, views_count, profile_public, visibility, bio')
      .order('views_count', { ascending: false })
      .limit(20);

    if(error){ wrap.innerHTML = '<div class="small muted">Failed to load trending.</div>'; console.error(error); return; }
    const rows = data || [];

    // filter public rows:
    const publicRows = rows.filter(r => {
      if(typeof r.profile_public === 'boolean') return r.profile_public === true;
      if(r.visibility && typeof r.visibility === 'object') {
        try { if(r.visibility.public === true) return true } catch(e){}
      }
      // fallback: treat as public if no explicit private flag is set
      return (r.profile_public === undefined && !r.visibility);
    });

    wrap.innerHTML = '';
    if(publicRows.length === 0){ wrap.innerHTML = '<div class="small muted">No trending profiles yet.</div>'; return; }

    publicRows.forEach(p => {
      const skills = Array.isArray(p.skills) ? p.skills.slice(0,3) : (p.skills ? p.skills.split(',').slice(0,3) : []);
      const card = document.createElement('div'); card.className = 'profile-card';
      card.innerHTML = `
        <div class="avatar">${p.avatar_url ? `<img src="${escapeHtml(p.avatar_url)}" alt="avatar" style="width:100%;height:100%;border-radius:999px;object-fit:cover">` : (p.username||'U').slice(0,2).toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(p.full_name || p.username)}</div>
          <div class="small muted">@${escapeHtml(p.username || (p.user_id||'user').slice(0,6))} · ${skills.join(', ')}</div>
        </div>
        <div class="small muted">${p.views_count||0} views</div>
      `;
      // click -> view public profile in Me section
      card.onclick = ()=> viewProfilePublic(p.username || p.id || p.user_id);
      wrap.appendChild(card);
    });

  }catch(err){
    console.error(err); wrap.innerHTML = '<div class="small muted">Error loading trending.</div>';
  }
}

/* ----- quick search on home top-right ----- */
function wireQuickSearch(){
  const quick = q('#quickSearch');
  quick.onkeydown = (e)=>{ if(e.key === 'Enter') doSearch(quick.value.trim()) }
  quick.onblur = ()=>{} // noop
  quick.addEventListener('input', async (e) => {
    // optional: live search (light)
  });
}

/* ----- SEARCH ----- */
q('#doSearch').onclick = async ()=> {
  const qv = q('#searchQ').value.trim();
  await doSearch(qv);
};

async function doSearch(qv){
  const results = q('#searchResults'); results.innerHTML = '<div class="small muted">Searching...</div>';
  if(!qv){ results.innerHTML = '<div class="small muted">Type a name, username, or skill.</div>'; return; }
  try{
    // prepared OR clause for ilike search
    const orClause = `username.ilike.%${qv}%,full_name.ilike.%${qv}%`;
    const { data, error } = await supabase
      .from('profiles')
      .select('id, user_id, username, full_name, skills, avatar_url, profile_public, visibility')
      .or(orClause)
      .limit(50);

    if(error){ results.innerHTML = '<div class="small muted">Search failed.</div>'; console.error(error); return; }
    const rows = data || [];

    // filter public
    const publicRows = rows.filter(r => {
      if(typeof r.profile_public === 'boolean') return r.profile_public === true;
      if(r.visibility && typeof r.visibility === 'object') {
        try { if(r.visibility.public === true) return true } catch(e){}
      }
      return (r.profile_public === undefined && !r.visibility); // fallback show
    });

    if(publicRows.length === 0){ results.innerHTML = '<div class="small muted">No results.</div>'; return; }
    results.innerHTML = '';
    publicRows.forEach(p => {
      const skills = Array.isArray(p.skills) ? p.skills.slice(0,4) : (p.skills? p.skills.split(',').slice(0,4):[]);
      const div = document.createElement('div'); div.className='profile-card';
      div.innerHTML = `
        <div class="avatar">${p.avatar_url ? `<img src="${escapeHtml(p.avatar_url)}" style="width:100%;height:100%;border-radius:999px;object-fit:cover">` : (p.username||'U').slice(0,2).toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(p.full_name || p.username)}</div>
          <div class="small muted">@${escapeHtml(p.username)} · ${skills.join(', ')}</div>
        </div>
      `;
      div.onclick = ()=> viewProfilePublic(p.username || p.id || p.user_id);
      results.appendChild(div);
    });
  }catch(err){ console.error(err); results.innerHTML = '<div class="small muted">Search error.</div>'; }
}

/* ----- View public profile flow (shows Me section in view mode) ----- */
async function viewProfilePublic(identifier){
  // open Me section in view-only mode
  showView('me');
  // fetch by username first, fallback to id
  let { data, error } = await supabase.from('profiles').select('*').eq('username', identifier).maybeSingle();
  if(!data){
    // maybe identifier is id/user_id
    const { data: d2 } = await supabase.from('profiles').select('*').or(`id.eq.${identifier},user_id.eq.${identifier}`).maybeSingle();
    data = d2;
  }
  if(!data){ q('#meMsg').textContent = 'Profile not found.'; q('#previewBox').style.display = 'none'; return; }

  // check public
  const isPublic = (typeof data.profile_public === 'boolean') ? data.profile_public : (data.visibility ? (data.visibility.public === true) : true);
  if(!isPublic){ q('#meMsg').textContent = 'Profile is private.'; q('#previewBox').style.display = 'none'; return; }

  // record view (anonymous ok)
  try{ await supabase.from('profile_views').insert([{ profile_id: data.id || data.user_id }]) }catch(e){ /* ignore */ }

  // render preview
  q('#previewBox').style.display = 'block';
  q('#publicPreview').innerHTML = `
    <div class="profile-card">
      <div class="avatar">${data.avatar_url ? `<img src="${escapeHtml(data.avatar_url)}" style="width:100%;height:100%;border-radius:999px;object-fit:cover">` : (data.username||'U').slice(0,2).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(data.full_name || data.username)}</div>
        <div class="small muted">@${escapeHtml(data.username)}</div>
        <div style="margin-top:8px">${escapeHtml(data.bio||'')}</div>
        <div class="chips" style="margin-top:8px">${(Array.isArray(data.skills)?data.skills:data.skills?data.skills.split(','):[]).map(s=>`<span class="chip">${escapeHtml(s)}</span>`).join('')}</div>
        <div style="margin-top:8px" class="small muted">Socials:</div>
        <div style="margin-top:6px">${renderSocials(data)}</div>
      </div>
    </div>
  `;
}

/* ----- load my profile (for Me edit) ----- */
async function loadMyProfile(){
  q('#meMsg').textContent = 'Loading your profile...';
  try{
    const userRes = await supabase.auth.getUser();
    const user = userRes.data?.user;
    if(!user){ q('#meMsg').textContent = ''; authSection.style.display = 'block'; nav.style.visibility = 'hidden'; return; }

    // try both patterns: id=user.id OR user_id=user.id
    let { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
    if(!data){
      const r = await supabase.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
      data = r.data; error = r.error;
    }
    if(error){ console.error(error); q('#meMsg').textContent = 'Failed to load profile.'; return; }

    const p = data || {}; // fallback empty

    // fill fields (handle both old/new schema)
    q('#p_username').value = p.username||'';
    q('#p_full_name').value = p.full_name||'';
    q('#p_father').value = p.father_name||p.father||'';
    q('#p_avatar').value = p.avatar_url||'';
    q('#p_bio').value = p.bio||'';
    q('#p_skills').value = Array.isArray(p.skills)?p.skills.join(', '):(p.skills||'');
    q('#p_interests').value = p.interests||'';
    q('#p_whatsapp').value = p.whatsapp||'';
    q('#p_instagram').value = p.instagram||'';
    q('#p_tiktok').value = p.tiktok||'';
    q('#p_facebook').value = p.facebook||'';
    // profile_public may be boolean OR in visibility JSON
    let pub = false;
    if(typeof p.profile_public === 'boolean') pub = p.profile_public;
    else if(p.visibility && typeof p.visibility === 'object') { try{ pub = p.visibility.public === true }catch(e){} }
    q('#p_public').checked = !!pub;
    // avatar preview
    if(p.avatar_url) q('#avatarPreview').innerHTML = `<img src="${escapeHtml(p.avatar_url)}" style="width:100%;height:100%;border-radius:999px;object-fit:cover">`;
    else q('#avatarPreview').textContent = (p.username||user.email||'UZ').slice(0,2).toUpperCase();

    q('#meMsg').textContent = '';
    // show Me view (if not currently)
    showView('me');
  }catch(e){ console.error(e); q('#meMsg').textContent = 'Error loading profile.'; }
}

/* ----- Save profile (Me) ----- */
q('#saveProfile').onclick = async () => {
  q('#meMsg').textContent = 'Saving...';
  try{
    const userRes = await supabase.auth.getUser();
    const user = userRes.data?.user;
    if(!user){ q('#meMsg').textContent = 'Sign in first.'; return; }

    // gather fields
    const payload = {
      username: q('#p_username').value.trim(),
      full_name: q('#p_full_name').value.trim(),
      father_name: q('#p_father').value.trim(),
      avatar_url: q('#p_avatar').value.trim(),
      bio: q('#p_bio').value.trim(),
      skills: (q('#p_skills').value || '').split(',').map(s=>s.trim()).filter(Boolean),
      interests: q('#p_interests').value.trim(),
      whatsapp: q('#p_whatsapp').value.trim(),
      instagram: q('#p_instagram').value.trim(),
      tiktok: q('#p_tiktok').value.trim(),
      facebook: q('#p_facebook').value.trim(),
      updated_at: new Date().toISOString()
    };

    // handle profile_public OR visibility JSON depending on schema
    if(q('#p_public').checked) { payload.profile_public = true; payload.visibility = { ...(payload.visibility||{}), public: true } }
    else { payload.profile_public = false; payload.visibility = { ...(payload.visibility||{}), public: false } }

    // We need to upsert using either id=user.id or user_id=user.id depending on your DB.
    // Try upsert using id (common if profiles.id references auth.users.id)
    payload.id = user.id; // attempt this
    let res = await supabase.from('profiles').upsert(payload, { onConflict: 'id' });
    if(res.error){
      // try user_id fallback
      delete payload.id;
      payload.user_id = user.id;
      res = await supabase.from('profiles').upsert(payload, { onConflict: 'user_id' });
    }

    if(res.error){ console.error(res.error); q('#meMsg').textContent = 'Save error: '+res.error.message; return; }
    q('#meMsg').textContent = 'Saved.';
    // refresh trending & preview
    await loadTrending();
    await loadMyProfile();
  }catch(e){ console.error(e); q('#meMsg').textContent = 'Save failed.'; }
};

/* ----- render socials for preview ----- */
function renderSocials(row){
  const parts = [];
  if(row.instagram) parts.push(`<div><a href="${escapeHtml(normalizeUrl(row.instagram))}" target="_blank">Instagram</a></div>`);
  if(row.tiktok) parts.push(`<div><a href="${escapeHtml(normalizeUrl(row.tiktok))}" target="_blank">TikTok</a></div>`);
  if(row.facebook) parts.push(`<div><a href="${escapeHtml(normalizeUrl(row.facebook))}" target="_blank">Facebook</a></div>`);
  if(row.whatsapp) parts.push(`<div><a href="https://wa.me/${escapeHtml(row.whatsapp)}" target="_blank">WhatsApp</a></div>`);
  return parts.join('') || '<span class="muted">No socials</span>';
}

/* ----- helper: normalize URL-ish inputs (very light) ----- */
function normalizeUrl(v){
  if(!v) return v;
  v = v.trim();
  if(v.startsWith('http')) return v;
  return 'https://' + v;
}

/* ----- escape HTML for safety in the UI ----- */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return s.toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ----- initial check: if user has session -> init app ----- */
(async function boot(){
  try{
    const { data } = await supabase.auth.getUser();
    if(data?.user){
      await initAfterSignIn();
    } else {
      // show auth UI
      authSection.style.display = 'block';
      nav.style.visibility = 'hidden';
      Object.keys(sections).forEach(k => sections[k].style.display = 'none');
    }
  }catch(e){
    console.error('Boot error', e);
    authSection.style.display = 'block';
  }
})();
</script>
</body>
</html>
